# 1.0 - Accessing the Lab
This guide will help you connect to the lab servers through an SSH tunnel. Inside that tunnel you will use SSH and other protocols to manage the lab servers and perform the lab exercises.

## Building the SSH tunnel
In this section you will configure your workstation to establish an SSH tunnel that you will later configure to pass specific TCP traffic from your workstation to the remote server.

### Platform-specific Notes
Windows systems may use PuTTY or another terminal emulator to control the SSH tunnel. Review the Mac/Linux setup instructions below to learn the specifics of the configuration. Due to the many permutations of configurations of Windows SSH clients, further details will not be contained here.

If you are running Mac or Linux as your workstation, follow these steps to configure the SSH tunnel.

#### Step 1: SSH Key Generation
You will need to create an SSH key pair to access the lab servers.

1. In a terminal window, run the following command to create a public/private key pair.
```
cd
ssh-keygen -q -b 2048 -N '' -t rsa -f .ssh/lab_rsa.key
```
2. Copy your SSH key to the server
```
ssh-copy-id -i .ssh/lab_rsa.key.pub <your_user_name>@<hostname>
```

#### Step 2: Update your SSH config file
You need to alter your SSH configuration files to create a tunnel that redirects specific TCP connections to "localhost" to your remote server on a different port number. For example, if your remote server is hosting Grafana on HTTP over TCP/3000, you could enter a configuration statement that would allow you to open a web browser on your local workstation to the address "http://localhost:3000" or you could choose another TCP port if port 3000 was already used by another service on your workstation. In this way you can pass multiple streams of traffic through the encrypted SSH tunnel, and yet only TCP/22 is open between your workstation and the lab firewall.

1. In a terminal window, create the `controlmasters` directory for the SSH tunnel.
```
mkdir ~/.ssh/controlmasters
```

2. Using a text editor, add the following text to the file `~/.ssh/config`:
```
Host lab-tunnel
    Hostname XXX.XXX.XXX.XXX
    IdentityFile ~/.ssh/lab_rsa.key
    ControlPath ~/.ssh/controlmasters/%r@%h:%p
    ControlMaster auto
    ControlPersist 5m
    LocalForward 52201 192.168.120.1:22
    LocalForward 52202 192.168.120.2:22
    LocalForward 52203 192.168.120.3:22
    LocalForward 52204 192.168.120.4:22
    LocalForward 52205 192.168.120.5:22
    LocalForward 52206 192.168.120.6:22
    LocalForward 52207 192.168.120.7:22
    LocalForward 52208 192.168.120.8:22
    LocalForward 52209 192.168.120.9:22
    LocalForward 52210 192.168.120.10:22
    LocalForward 52211 192.168.120.11:22
    LocalForward 52212 192.168.120.12:22
    LocalForward 52213 192.168.120.13:22
    LocalForward 52214 192.168.120.14:22
    LocalForward 52215 192.168.120.15:22
    LocalForward 52216 192.168.120.16:22
    LocalForward 52217 192.168.120.17:22
    LocalForward 52218 192.168.120.18:22
    LocalForward 52219 192.168.120.19:22
    LocalForward 52220 192.168.120.20:22
    User <your_user_name>

```
3. Save the file and close the text editor.


#### Step 3: Initializing the SSH tunnel
Once you have configured the key pair and mapped the ports in your SSH configuration file, you can open the SSH tunnel.

1. In a terminal window, launch the SSH tunnel with the -fN option to open the connection, but run it in the background without opening a shell or running any commands. This will establish the tunnel that you will use to connect to your lab server.
```
ssh -fN lab-tunnel
```
2. You can determine if the SSH tunnel is open and listening for connections by typing this command:
```
ssh -O status lab-tunnel
```

**Note:**
> You have configured the SSH tunnel to automatically time out if you have no connections open for 5 minutes; however you can manually close the SSH tunnel by typing: `ssh -O stop lab-tunnel'
 
 

 
## Using the SSH tunnel
If you used the SSH tunnel configuration above, you can access ports on your server through redirection. In the configuration above you mapped the local port **TCP/52201** to *TCP/22* on the lab server 192.168.120.1.

Open an SSH connection to your localhost on port **TCP/52201**. This will actually connect to port *TCP/22* on the first lab server. **Change the last two digits of the port to match your assigned lab server.**
```
ssh <username>@localhost -p 52201
```
**Note:**
> This command will redirect input and output over the encrypted SSH tunnel. You may add more ports by editing the SSH config file; however for the change to take effect, you must close the SSH tunnel by typing `ssh -O stop lab-tunnel`, and then restart the tunnel by typing `ssh -fN lab-tunnel`.




# SSH Tunnels
This document helps you configure your workstation to support SSH tunnels that you can use to access services behind a firewall. This procedure can be used recursively to connect multiple SSH tunnels together for multi-hop configurations, such as when the firewall only accept connections from known public IP addresses.


## Steps
1. Initiate a tunnel from the student's PC to the cloud VM.
2. Initiate a tunnel from the cloud VM to the Lab.
3. On the student's PC, open a browser or SSH client.
4. Connect to the address "localhost" using the port number per the tables below. For example, to connect to SSH on ICN15, you would connect to localhost:51522.



## Port Numbering Schema

**Port Mapping table**

Examples:
z01xx --> Remote TCP/443 on RMM IP (HTTPS to RMM)
z22xx --> Remote TCP/22 (SSH)
z43xx --> Remote TCP/443 (HTTPS)
z80xx --> Remote TCP/80 (HTTP)


**Local Port Redirection Mappings**

Example: 52201

5 22 01  Port 52201
| |  |
| |  |
| |  +-- Double: Server Number (ICN##)
| |
| +----- Double: Port Mapping (See table)
|
+------- Single: Lab Group (5 = Rio Rancho)


### For Example:
* `localhost:50101` Relays to: `192.168.123.1:443`  (RMM: ICN01)
* `localhost:50102` Relays to: `192.168.123.2:443`  (RMM: ICN02)
* `localhost:52201` Relays to: `192.168.120.1:22`   (ICN01 - SSH)
* `localhost:52202` Relays to: `192.168.120.2:22`   (ICN02 - SSH)
* `localhost:53001` Relays to: `192.168.120.1:3000` (ICN01 - Grafana)
* `localhost:53002` Relays to: `192.168.120.2:3000` (ICN02 - Grafana)





## Primary SSH Config file
This is the configuration that must be added to the student's machine. It allows them access to any of the servers in the lab. Copy the contents to the `~/.ssh/config` file on the student's computer.
Be sure to create the directory `~/.ssh/controlmasters` or else the control master will be unable to create the sockets.
```
Host lab-tunnel
    Hostname <x.y.z.68>
    IdentityFile ~/.ssh/id_rsa
    ControlPath ~/.ssh/controlmasters/%r@%h:%p
    ControlMaster auto
    ControlPersist 10m
    User <username>
    LocalForward 52201 192.168.120.1:22
    LocalForward 52202 192.168.120.2:22
    LocalForward 52203 192.168.120.3:22
    LocalForward 52204 192.168.120.4:22
    LocalForward 52205 192.168.120.5:22
    LocalForward 52206 192.168.120.6:22
    LocalForward 52207 192.168.120.7:22
    LocalForward 52208 192.168.120.8:22
    LocalForward 52209 192.168.120.9:22
    LocalForward 52210 192.168.120.10:22
    LocalForward 52211 192.168.120.11:22
    LocalForward 52212 192.168.120.12:22
    LocalForward 52213 192.168.120.13:22
    LocalForward 52214 192.168.120.14:22
    LocalForward 52215 192.168.120.15:22
    LocalForward 52216 192.168.120.16:22
    LocalForward 52217 192.168.120.17:22
    LocalForward 52218 192.168.120.18:22
    LocalForward 52219 192.168.120.19:22
    LocalForward 52220 192.168.120.20:22
```


## Public VM variant for the SSH Tunnel
This configuration is only used if the student must hop through another SSH endpoint, such as a VM running in the public cloud.
Otherwise do not use the below configuration.
Be sure to create the directory `~/.ssh/controlmasters` or else the control master will be unable to create the sockets.
```
Host relay-tunnel
    Hostname 35.x.y.z
    IdentityFile ~/.ssh/id_rsa
    ControlPath ~/.ssh/controlmasters/%r@%h:%p
    ControlMaster auto
    ControlPersist 10m
    LocalForward 52201 localhost:52201
    LocalForward 52202 localhost:52202
    LocalForward 52203 localhost:52203
    LocalForward 52204 localhost:52204
    LocalForward 52205 localhost:52205
    LocalForward 52206 localhost:52206
    LocalForward 52207 localhost:52207
    LocalForward 52208 localhost:52208
    LocalForward 52209 localhost:52209
    LocalForward 52210 localhost:52210
    LocalForward 52211 localhost:52211
    LocalForward 52212 localhost:52212
    LocalForward 52213 localhost:52213
    LocalForward 52214 localhost:52214
    LocalForward 52215 localhost:52215
    LocalForward 52216 localhost:52216
    LocalForward 52217 localhost:52217
    LocalForward 52218 localhost:52218
    LocalForward 52219 localhost:52219
    LocalForward 52220 localhost:52220

```
